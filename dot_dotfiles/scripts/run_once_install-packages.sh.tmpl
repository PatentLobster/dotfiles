#!/bin/bash

info () {
  printf "\r  [ \033[00;34m..\033[0m ] $1\n"
}

user () {
  printf "\r  [ \033[0;33m??\033[0m ] $1\n"
}

success () {
  printf "\r\033[2K  [ \033[00;32mOK\033[0m ] $1\n"
}

fail () {
  printf "\r\033[2K  [\033[0;31mFAIL\033[0m] $1\n"
  echo ''
  exit
}

chez () {
if command -v chezmoi &> /dev/null; then
	chezmoi $@
else
	$HOME/bin/chezmoi $@
fi
}


lobster () {
	if command -v lolcat &> /dev/null; then
		lobster_printer="lolcat"
	else
		lobster_printer="cat"
	fi
	eval $lobster_printer $(chez source-path)/dot_dotfiles/scripts/lobster
    printf "\n"
}



get_latest_release() {
  curl --silent "https://api.github.com/repos/$1/releases/latest" | # Get latest release from GitHub api
    grep '"tag_name":' |                                            # Get tag line
    sed -E 's/.*"([^"]+)".*/\1/'                                    # Pluck JSON value
}

install_brew() {
    if test ! $(which brew); then
        info "Installing brew ðŸº"
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        {{ if ne .chezmoi.os "darwin" }}
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        {{ end }}
    fi
    if test ! $(which gum); then
        info "Installing gum ðŸ”®"
        brew install gum
    fi
}

lobster
install_brew

{{ if eq .chezmoi.os "darwin" }}
# macOS-specific code

set +e
info "Installing brew packages ðŸ“¦"
brew bundle --no-lock --file=$(chez source-path)/dot_dotfiles/Brewfile
set -e

info "Installing vim plugins ðŸ‘¾"
vim +PlugInstall +qall > /dev/null

{{ else if eq .chezmoi.os "linux" }}
{{   if eq .chezmoi.osRelease.idLike "debian" }}
# Debian-specific code

info "Installing deps ðŸš€"
sudo apt update
sudo apt install -y wget curl tmux zsh zoxide python3-dev python3-pip python3-setuptools

info "Installing brew packages ðŸ“¦"
brew install thefuck lolcat

{{      if eq .chezmoi.arch "amd64" }}
wget https://github.com/Peltoche/lsd/releases/download/$(get_latest_release "Peltoche/lsd")/lsd-musl_$(get_latest_release "Peltoche/lsd")_amd64.deb -O /tmp/lsd.deb
{{      else }}
wget https://github.com/Peltoche/lsd/releases/download/$(get_latest_release "Peltoche/lsd")/lsd-musl_$(get_latest_release "Peltoche/lsd")_arm64.deb -O /tmp/lsd.deb
{{      end }}

sudo dpkg -i /tmp/lsd.deb

info "Installing vim plugins ðŸ‘¾"
vim +PlugInstall +qall > /dev/null

{{   else if eq .chezmoi.osRelease.id "fedora" }}
# Fedora-specific code
info "Installing deps ðŸš€"
sudo yum -y groupinstall 'Development Tools'
sudo dnf -y install zsh zoxide lsd tmux


info "Installing brew packages ðŸ“¦"
brew install thefuck lolcat

info "Installing vim plugins ðŸ‘¾"
vim +PlugInstall +qall > /dev/null


{{   end }}
{{ end }}

info "Setting zsh as default shell"
set +e
{{ if eq .chezmoi.os "darwin" }}
chsh -s $(which zsh)
{{ else }}
chsh $(whoami) -s $(which zsh)
{{ end }}

success "Installation complete"

lobster